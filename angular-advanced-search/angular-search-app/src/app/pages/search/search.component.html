<p-toast />

<div class="search-page">
  <!-- Header -->
  <div class="search-page__header">
    <div class="search-page__title">
      <i class="pi pi-search search-page__icon"></i>
      <div>
        <h1>Advanced Search</h1>
        <p>Build complex queries to find exactly what you're looking for</p>
      </div>
    </div>
  </div>

  <!-- Search Card -->
  <p-card styleClass="search-card">
    <!-- KQL-like text search -->
    <div class="search-bar">
      <div class="search-bar__input-wrapper">
        <i class="pi pi-search search-bar__icon"></i>
        <input
          pInputText
          [(ngModel)]="searchText"
          placeholder='Search all fields... (e.g. "engineering" or "alice")'
          class="search-bar__input"
          (keydown.enter)="search()"
        />
        @if (searchText) {
          <button
            pButton
            icon="pi pi-times"
            class="p-button-text p-button-rounded search-bar__clear"
            (click)="searchText = ''"
          ></button>
        }
      </div>
    </div>

    <p-divider />

    <!-- Filter Builder -->
    <div class="filter-section">
      <div class="filter-section__header">
        <h3 class="filter-section__title">
          <i class="pi pi-filter"></i>
          Filters
          @if (activeFilterCount > 0) {
            <span class="filter-badge">{{ activeFilterCount }}</span>
          }
        </h3>
        @if (activeFilterCount > 0) {
          <button
            pButton
            label="Clear all"
            icon="pi pi-trash"
            class="p-button-text p-button-sm p-button-danger"
            (click)="clearFilters()"
          ></button>
        }
      </div>

      @if (fieldsLoading) {
        <div class="loading-fields">
          <p-progressSpinner styleClass="loading-spinner" strokeWidth="4" />
          <span>Connecting to mock server...</span>
        </div>
      } @else {
        <app-filter-builder
          [fields]="fields"
          [filters]="filters"
          [combinator]="combinator"
          (filtersChange)="onFiltersChange($event)"
          (combinatorChange)="onCombinatorChange($event)"
        />
      }
    </div>

    <ng-template pTemplate="footer">
      <div class="search-actions">
        @if (hasSearch) {
          <div class="search-summary">
            @if (searchText) {
              <span class="search-summary__item">
                <i class="pi pi-search"></i> "{{ searchText }}"
              </span>
            }
            @if (activeFilterCount > 0) {
              <span class="search-summary__item">
                <i class="pi pi-filter"></i>
                {{ activeFilterCount }} filter{{ activeFilterCount > 1 ? 's' : '' }}
                ({{ combinator.toUpperCase() }})
              </span>
            }
          </div>
        }
        <div class="search-actions__buttons">
          <button
            pButton
            label="Clear"
            icon="pi pi-times"
            class="p-button-outlined p-button-secondary"
            (click)="clearFilters()"
            [disabled]="!hasSearch"
          ></button>
          <button
            pButton
            label="Search"
            icon="pi pi-search"
            class="search-btn"
            (click)="search()"
          ></button>
        </div>
      </div>
    </ng-template>
  </p-card>

  <!-- Tips -->
  <div class="search-tips">
    <i class="pi pi-lightbulb"></i>
    <span><strong>Tips:</strong> Use the text field for quick searches across all fields, or add filters to search specific fields with precise operators. Combine both for powerful queries.</span>
  </div>
</div>
